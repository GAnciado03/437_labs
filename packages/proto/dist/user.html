<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Source+Code+Pro:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded"
      rel="stylesheet"
    />

    <link rel="icon" type="image/x-icon" href="/assets/favicon-Cb2dxQey.ico" />
    <script type="module" crossorigin src="/assets/pages-rLHsPmH1.js"></script>
    <script type="module" crossorigin src="/assets/user-button-ifhGABLi.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/pages-zY_jnpoo.css">
  </head>
  <body>
    <main class="container" id="user-content"></main>
    <script>
      (function() {
        const el = document.getElementById('user-content');
        const token = (() => { try { return localStorage.getItem('token'); } catch { return null; } })();
        if (!el) return;
        if (!token) {
          el.innerHTML = `
            <section style="max-width: 420px; margin: 15vh auto; text-align: center;">
              <h1>User</h1>
              <p style="margin: var(--space-3) 0;">
                <a class="mono" href="login.html" style="display:inline-block;padding:.6rem 1rem;border:1px solid var(--color-border);border-radius:10px;">Log In</a>
              </p>
              <p>
                <a class="mono" href="newuser.html" style="display:inline-block;padding:.5rem 1rem;border:1px solid var(--color-border);border-radius:10px;">Register</a>
              </p>
              <p style="margin-top: var(--space-3)"><a href="index.html">Back to Home</a></p>
            </section>
          `;
          return;
        }
        const prof = (() => { try { return JSON.parse(localStorage.getItem('profile')||'{}'); } catch { return {}; } })();
        const uname = prof?.username || (prof.first && prof.last ? `${prof.first} ${prof.last}` : 'User');
        const unameUpper = String(uname).toUpperCase();
        // Try to load server-side favorites/profile; fall back to localStorage
        let favPlayers = (()=>{ try { return JSON.parse(localStorage.getItem('favPlayers')||'[]'); } catch { return []; } })();
        let favTeams = (()=>{ try { return JSON.parse(localStorage.getItem('favTeams')||'[]'); } catch { return []; } })();
        try {
          const meRes = fetch('/api/me', { headers: { 'Authorization': `Bearer ${token}` } });
          meRes.then(r => r.ok ? r.json() : null).then((me) => {
            if (me) {
              favPlayers = Array.isArray(me.favPlayers) ? me.favPlayers : favPlayers;
              favTeams = Array.isArray(me.favTeams) ? me.favTeams : favTeams;
              // sync local for quicker UI next time
              try { localStorage.setItem('favPlayers', JSON.stringify(favPlayers)); } catch {}
              try { localStorage.setItem('favTeams', JSON.stringify(favTeams)); } catch {}
            }
            render();
          }).catch(render);
        } catch { /* ignore */ }

        function render() {
          const favPlayersList = favPlayers.map((id)=>`<li><a href="stats.html?id=${id}">${id}</a></li>`).join('') || '<li class="muted">None</li>';
          const favTeamsList = favTeams.map((id)=>`<li><a href="team.html?id=${encodeURIComponent(id)}">${id}</a></li>`).join('') || '<li class="muted">None</li>';
          const playerItems = (favPlayers.length ? favPlayers : ['None'])
            .map((id) => id === 'None'
              ? `<li class="muted" style="display:flex;justify-content:center;">None</li>`
              : `<li style="display:flex;align-items:center;gap:.5rem;justify-content:center;">
                  <svg class="icon" aria-hidden="true"><use href="icons/icons.svg#player-icon-default"></use></svg>
                 <a href="stats.html?id=${id}">${id}</a>
                </li>`)
            .join('');

        const teamItems = (favTeams.length ? favTeams : ['None'])
          .map((id) => id === 'None'
            ? `<li class="muted" style="display:flex;justify-content:center;">None</li>`
            : `<li style="display:flex;align-items:center;gap:.5rem;justify-content:center;">
                 <svg class="icon" aria-hidden="true"><use href="icons/icons.svg#icon-team"></use></svg>
                 <a href="team.html?id=${encodeURIComponent(id)}">${id}</a>
               </li>`)
          .join('');

        el.innerHTML = `
          <section style="max-width: 900px; margin: 1rem auto;">
            <p style="margin: 0 0 var(--space-2); display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
              <a href="index.html">Back to Home</a>
              <button id="logout-btn" class="mono" style="font-weight:600; font-size:.95rem; padding:.35rem .7rem; border:1px solid var(--color-border); background:var(--color-surface); color:var(--color-text); border-radius:var(--radius-sm);">Log Out</button>
            </p>
            <h1 style="text-align:center; margin: 0;">Hey ${unameUpper}</h1>
            <p style="text-align:center; margin: 0;">
              <button
                type="button"
                class="mono"
                data-theme-button
                aria-pressed="false"
                data-label-on="Dark: On"
                data-label-off="Dark: Off"
                style="font-weight:600; font-size:.95rem; padding:.25rem .5rem; border:1px solid var(--color-border); background:var(--color-surface); color:var(--color-text); border-radius:var(--radius-sm);"
              >Dark: Off</button>
            </p>
            <div style="text-align:center; margin-top: 0;">
              <svg class="icon" aria-hidden="true" style="--icon-size: 40px; width: var(--icon-size); height: var(--icon-size);"><use href="icons/icons.svg#user-default"></use></svg>
            </div>
            <h2 style="margin: 0; text-align:center;">Favorites</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: .5rem; max-width:720px; margin: 0 auto;">
              <div>
                <h3 style="text-align:center;">Players</h3>
                <ul style="list-style:none; padding:0; margin:0;">${playerItems}</ul>
              </div>
              <div>
                <h3 style="text-align:center;">Teams</h3>
                <ul style="list-style:none; padding:0; margin:0;">${teamItems}</ul>
              </div>
           </div>
          </section>
        `;
        // Hook up logout
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn?.addEventListener('click', () => {
          try {
            localStorage.removeItem('token');
            localStorage.removeItem('profile');
            localStorage.removeItem('favPlayers');
            localStorage.removeItem('favTeams');
          } catch {}
          location.href = 'index.html';
        });
        // Ensure theme button toggles even when rendered dynamically
        const themeBtn = el.querySelector('[data-theme-button]');
        themeBtn?.addEventListener('click', () => {
          document.body.dispatchEvent(new CustomEvent('theme-toggle', { bubbles: true }));
        });
        }
        // If we didnâ€™t render via async path yet, render immediately with local values
        if (!el.innerHTML) render();
      })();
    </script>
  </body>
</html>
